// SPDX-License-Identifier: MIT
pragma solidity >=0.8.0 <0.9.0;

import "./MultiSigWallet.sol";

contract MultiSigFactory {
  MultiSigWallet[] public multiSigs;
  mapping(address => bool) existsMultiSig;

  event Create(
    uint indexed contractId,
    address indexed contractAddress,
    address creator,
    address[] owners,
    uint signaturesRequired
  );

  event Owners(
    address indexed contractAddress,
    address[] owners,
    uint256 indexed signaturesRequired
  );


  constructor() {}

  modifier onlyRegistered() {
    require(existsMultiSig[msg.sender], "caller not registered to use logger");
    _;
  }

  function emitOwners(
    address _contractAddress,
    address[] memory _owners,
    uint256 _signaturesRequired
  ) external onlyRegistered {
    emit Owners(_contractAddress, _owners, _signaturesRequired);
  }

  function create(
    uint256 _chainId,
    address[] memory _owners,
    uint _signaturesRequired
  ) public payable {
    uint id = numberOfMultiSigs();

    address payable addr;
    uint256 salt = 1;
    bytes memory contractBytecode = "0x60806040526040516200190438038062001904833981016040819052620000269162000285565b81600081116200007d5760405162461bcd60e51b815260206004820152601e60248201527f4d757374206265206e6f6e2d7a65726f2073696773207265717569726564000060448201526064015b60405180910390fd5b600080546001600160a01b0319166001600160a01b03841617815560038490555b845181101562000256576000858281518110620000cb57634e487b7160e01b600052603260045260246000fd5b6020026020010151905060006001600160a01b0316816001600160a01b031614156200013a5760405162461bcd60e51b815260206004820152601960248201527f636f6e7374727563746f723a207a65726f206164647265737300000000000000604482015260640162000074565b6001600160a01b03811660009081526001602052604090205460ff1615620001a55760405162461bcd60e51b815260206004820152601d60248201527f636f6e7374727563746f723a206f776e6572206e6f7420756e69717565000000604482015260640162000074565b6001600160a01b038116600081815260016020818152604092839020805460ff1916831781556002805493840190557f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace90920180546001600160a01b031916851790559054915160ff909216151582527ffe545f48304051c4029eb2da9927daa59da0414b4b084fdceaf2955b609b899e910160405180910390a250806200024d8162000383565b9150506200009e565b50505060059290925550620003c19050565b80516001600160a01b03811681146200028057600080fd5b919050565b600080600080608085870312156200029b578384fd5b8451602080870151919550906001600160401b0380821115620002bc578586fd5b818801915088601f830112620002d0578586fd5b815181811115620002e557620002e5620003ab565b8060051b604051601f19603f830116810181811085821117156200030d576200030d620003ab565b604052828152858101935084860182860187018d10156200032c57898afd5b8995505b838610156200035957620003448162000268565b85526001959095019493860193860162000330565b5080985050505050505060408501519150620003786060860162000268565b905092959194509250565b6000600019821415620003a457634e487b7160e01b81526011600452602481fd5b5060010190565b634e487b7160e01b600052604160045260246000fd5b61153380620003d16000396000f3fe6080604052600436106100a05760003560e01c8063545a4a3c11610064578063545a4a3c146101c557806365af1bed146101f35780639a8a059214610213578063affed0e014610229578063ce757d291461023f578063d1fbffa01461025557600080fd5b8063025e7c27146100e657806319045a25146101235780632f54bf6e146101435780633034a742146101835780633bad5426146101a557600080fd5b366100e1576040805134815247602082015233917f90890809c654f11d6e72a28fa60149770a0d11ec6c92319d6ceb2bb0a4ea1a15910160405180910390a2005b600080fd5b3480156100f257600080fd5b506101066101013660046111d7565b610282565b6040516001600160a01b0390911681526020015b60405180910390f35b34801561012f57600080fd5b5061010661013e366004611192565b6102ac565b34801561014f57600080fd5b5061017361015e366004611049565b60016020526000908152604090205460ff1681565b604051901515815260200161011a565b34801561018f57600080fd5b506101a361019e3660046111d7565b610316565b005b3480156101b157600080fd5b506101a36101c0366004611167565b610365565b3480156101d157600080fd5b506101e56101e03660046111ef565b6104db565b60405190815260200161011a565b3480156101ff57600080fd5b506101a361020e366004611167565b61051a565b34801561021f57600080fd5b506101e560055481565b34801561023557600080fd5b506101e560045481565b34801561024b57600080fd5b506101e560035481565b34801561026157600080fd5b50610275610270366004611065565b6106b6565b60405161011a91906113aa565b6002818154811061029257600080fd5b6000918252602090912001546001600160a01b0316905081565b600061030f82610309856040517f19457468657265756d205369676e6564204d6573736167653a0a3332000000006020820152603c8101829052600090605c01604051602081830303815290604052805190602001209050919050565b906109b6565b9392505050565b33301461033e5760405162461bcd60e51b8152600401610335906113bd565b60405180910390fd5b806000811161035f5760405162461bcd60e51b8152600401610335906113df565b50600355565b3330146103845760405162461bcd60e51b8152600401610335906113bd565b80600081116103a55760405162461bcd60e51b8152600401610335906113df565b6001600160a01b03831660009081526001602052604090205460ff1661040d5760405162461bcd60e51b815260206004820152601760248201527f72656d6f76655369676e65723a206e6f74206f776e65720000000000000000006044820152606401610335565b610416836109da565b60038290556001600160a01b03831660008181526001602090815260409182902054915160ff909216151582527ffe545f48304051c4029eb2da9927daa59da0414b4b084fdceaf2955b609b899e91015b60405180910390a2600054604051632fb7d0a560e21b81526001600160a01b039091169063bedf4294906104a49030906002908790600401611345565b600060405180830381600087803b1580156104be57600080fd5b505af11580156104d2573d6000803e3d6000fd5b50505050505050565b600030600554868686866040516020016104fa9695949392919061127c565b604051602081830303815290604052805190602001209050949350505050565b3330146105395760405162461bcd60e51b8152600401610335906113bd565b806000811161055a5760405162461bcd60e51b8152600401610335906113df565b6001600160a01b0383166105b05760405162461bcd60e51b815260206004820152601760248201527f6164645369676e65723a207a65726f20616464726573730000000000000000006044820152606401610335565b6001600160a01b03831660009081526001602052604090205460ff16156106195760405162461bcd60e51b815260206004820152601b60248201527f6164645369676e65723a206f776e6572206e6f7420756e6971756500000000006044820152606401610335565b6001600160a01b038316600081815260016020818152604092839020805460ff1916831781556002805493840190557f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace90920180546001600160a01b0319168517905560038690559054915160ff909216151582527ffe545f48304051c4029eb2da9927daa59da0414b4b084fdceaf2955b609b899e9101610467565b3360009081526001602052604090205460609060ff166107045760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b6044820152606401610335565b60006107146004548787876104db565b600480549192506000610726836114a1565b919050555060008060005b855181101561083557600061076d8588848151811061076057634e487b7160e01b600052603260045260246000fd5b60200260200101516102ac565b9050826001600160a01b0316816001600160a01b0316116107ee5760405162461bcd60e51b815260206004820152603560248201527f657865637574655472616e73616374696f6e3a206475706c6963617465206f7260448201527420756e6f726465726564207369676e61747572657360581b6064820152608401610335565b6001600160a01b038116600090815260016020526040902054909250829060ff1615610822578361081e816114a1565b9450505b508061082d816114a1565b915050610731565b506003548210156108a05760405162461bcd60e51b815260206004820152602f60248201527f657865637574655472616e73616374696f6e3a206e6f7420656e6f756768207660448201526e616c6964207369676e61747572657360881b6064820152608401610335565b600080896001600160a01b031689896040516108bc91906112d7565b60006040518083038185875af1925050503d80600081146108f9576040519150601f19603f3d011682016040523d82523d6000602084013e6108fe565b606091505b5091509150816109505760405162461bcd60e51b815260206004820152601d60248201527f657865637574655472616e73616374696f6e3a207478206661696c65640000006044820152606401610335565b336001600160a01b03167f9053e9ec105157fac8c9308d63e6b22be5f50fe915a3e567419b624311a02d748b8b8b600160045461098d9190611447565b8a876040516109a1969594939291906112f3565b60405180910390a29998505050505050505050565b60008060006109c58585610c4e565b915091506109d281610cbe565b509392505050565b6001600160a01b0381166000908152600160205260408120805460ff19169055600254908167ffffffffffffffff811115610a2557634e487b7160e01b600052604160045260246000fd5b604051908082528060200260200182016040528015610a4e578160200160208202803683370190505b5090506000610a5e600184611447565b90505b836001600160a01b031660028281548110610a8c57634e487b7160e01b600052603260045260246000fd5b6000918252602090912001546001600160a01b031614610b6b5760028181548110610ac757634e487b7160e01b600052603260045260246000fd5b9060005260206000200160009054906101000a90046001600160a01b0316828281518110610b0557634e487b7160e01b600052603260045260246000fd5b60200260200101906001600160a01b031690816001600160a01b0316815250506002805480610b4457634e487b7160e01b600052603160045260246000fd5b600082815260209020810160001990810180546001600160a01b0319169055019055610c36565b6002805480610b8a57634e487b7160e01b600052603160045260246000fd5b600082815260209020810160001990810180546001600160a01b0319169055019055805b610bb9600185611447565b811015610c2f576002838281518110610be257634e487b7160e01b600052603260045260246000fd5b60209081029190910181015182546001810184556000938452919092200180546001600160a01b0319166001600160a01b0390921691909117905580610c27816114a1565b915050610bae565b5050505050565b80610c408161148a565b915050610a61565b50505050565b600080825160411415610c855760208301516040840151606085015160001a610c7987828585610ec2565b94509450505050610cb7565b825160401415610caf5760208301516040840151610ca4868383610faf565b935093505050610cb7565b506000905060025b9250929050565b6000816004811115610ce057634e487b7160e01b600052602160045260246000fd5b1415610ce95750565b6001816004811115610d0b57634e487b7160e01b600052602160045260246000fd5b1415610d595760405162461bcd60e51b815260206004820152601860248201527f45434453413a20696e76616c6964207369676e617475726500000000000000006044820152606401610335565b6002816004811115610d7b57634e487b7160e01b600052602160045260246000fd5b1415610dc95760405162461bcd60e51b815260206004820152601f60248201527f45434453413a20696e76616c6964207369676e6174757265206c656e677468006044820152606401610335565b6003816004811115610deb57634e487b7160e01b600052602160045260246000fd5b1415610e445760405162461bcd60e51b815260206004820152602260248201527f45434453413a20696e76616c6964207369676e6174757265202773272076616c604482015261756560f01b6064820152608401610335565b6004816004811115610e6657634e487b7160e01b600052602160045260246000fd5b1415610ebf5760405162461bcd60e51b815260206004820152602260248201527f45434453413a20696e76616c6964207369676e6174757265202776272076616c604482015261756560f01b6064820152608401610335565b50565b6000807f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0831115610ef95750600090506003610fa6565b8460ff16601b14158015610f1157508460ff16601c14155b15610f225750600090506004610fa6565b6040805160008082526020820180845289905260ff881692820192909252606081018690526080810185905260019060a0016020604051602081039080840390855afa158015610f76573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116610f9f57600060019250925050610fa6565b9150600090505b94509492505050565b6000806001600160ff1b03831660ff84901c601b01610fd087828885610ec2565b935093505050935093915050565b600082601f830112610fee578081fd5b813567ffffffffffffffff811115611008576110086114d2565b61101b601f8201601f1916602001611416565b81815284602083860101111561102f578283fd5b816020850160208301379081016020019190915292915050565b60006020828403121561105a578081fd5b813561030f816114e8565b6000806000806080858703121561107a578283fd5b8435611085816114e8565b93506020858101359350604086013567ffffffffffffffff808211156110a9578485fd5b6110b589838a01610fde565b945060608801359150808211156110ca578384fd5b818801915088601f8301126110dd578384fd5b8135818111156110ef576110ef6114d2565b8060051b6110fe858201611416565b8281528581019085870183870188018e1015611118578889fd5b8893505b848410156111555780358681111561113257898afd5b6111408f8a838b0101610fde565b8452506001939093019291870191870161111c565b50999c989b5096995050505050505050565b60008060408385031215611179578182fd5b8235611184816114e8565b946020939093013593505050565b600080604083850312156111a4578182fd5b82359150602083013567ffffffffffffffff8111156111c1578182fd5b6111cd85828601610fde565b9150509250929050565b6000602082840312156111e8578081fd5b5035919050565b60008060008060808587031215611204578384fd5b843593506020850135611216816114e8565b925060408501359150606085013567ffffffffffffffff811115611238578182fd5b61124487828801610fde565b91505092959194509250565b6000815180845261126881602086016020860161145e565b601f01601f19169290920160200192915050565b60006bffffffffffffffffffffffff19808960601b168352876014840152866034840152808660601b1660548401525083606883015282516112c581608885016020870161145e565b91909101608801979650505050505050565b600082516112e981846020870161145e565b9190910192915050565b60018060a01b038716815285602082015260c06040820152600061131a60c0830187611250565b85606084015284608084015282810360a08401526113388185611250565b9998505050505050505050565b60006060820160018060a01b03808716845260206060818601528287548085526080870191508886528286209450855b81811015611393578554851683526001958601959284019201611375565b505080945050505050826040830152949350505050565b60208152600061030f6020830184611250565b6020808252600890820152672737ba1029b2b63360c11b604082015260600190565b6020808252601e908201527f4d757374206265206e6f6e2d7a65726f20736967732072657175697265640000604082015260600190565b604051601f8201601f1916810167ffffffffffffffff8111828210171561143f5761143f6114d2565b604052919050565b600082821015611459576114596114bc565b500390565b60005b83811015611479578181015183820152602001611461565b83811115610c485750506000910152565b600081611499576114996114bc565b506000190190565b60006000198214156114b5576114b56114bc565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052604160045260246000fd5b6001600160a01b0381168114610ebf57600080fdfea2646970667358221220130a1dbeeabb9f56f72ca2bd92b075191e2abed435b346a03b2929caf5ee573464736f6c63430008040033";

    contractBytecode = abi.encodePacked(contractBytecode, abi.encode(_chainId, _owners, _signaturesRequired, address(this)));

    assembly {
        addr := create2(0, add(contractBytecode, 0x20), mload(contractBytecode), salt)

        if iszero(extcodesize(addr)) {
            revert(0, 0)
        }
    }


    //MultiSigWallet multiSig = (new MultiSigWallet){value: msg.value}(_chainId, _owners, _signaturesRequired, address(this));
    MultiSigWallet multiSig = MultiSigWallet(addr);

    multiSigs.push(multiSig);
    existsMultiSig[address(multiSig)] = true;

    emit Create(id, address(multiSig), msg.sender, _owners, _signaturesRequired);
    emit Owners(address(multiSig), _owners, _signaturesRequired);
  }

  function numberOfMultiSigs() public view returns(uint) {
    return multiSigs.length;
  }

  function getMultiSig(uint256 _index)
    public
    view
    returns (
      address multiSigAddress,
      uint signaturesRequired,
      uint balance
    ) {
      MultiSigWallet multiSig = multiSigs[_index];
      return (address(multiSig), multiSig.signaturesRequired(), address(multiSig).balance);
    }
}
